# encoding: utf-8
%YAML 1.2
---

- set_fact:
    config_dir: '/opt/instana/agent/etc/'
    config_prefix: '/opt/instana/agent/etc/instana/com.instana.agent.'

- name: 'template maven proxy + mirror settings config'
  template:
    dest:  "{{ config_dir }}mvn-settings.xml"
    src: 'templates/maven_settings.j2'
    group: "{{ instana.agent.group }}"
    owner: "{{ instana.agent.user }}"
    mode: 644

- name: 'template agent backend config'
  template:
    dest:  "{{ config_prefix }}main.sender.Backend.cfg"
    src: 'templates/agent_backend.j2'
    group: "{{ instana.agent.group }}"
    owner: "{{ instana.agent.user }}"
    mode: 644

- name: 'template agent sensor version pin config'
  template:
    dest: "{{ config_prefix }}main.bootstrap.AgentBootstrap.cfg"
    src: 'templates/agent_bootstrap.j2'
    group: "{{ instana.agent.group }}"
    owner: "{{ instana.agent.user }}"
    mode: 644
  when: instana.agent.updates.pin != "" and instana.agent.updates.enabled|bool

- name: 'template agent update config'
  template:
    dest:  "{{ config_prefix }}main.config.UpdateManager.cfg"
    src: 'templates/agent_update.j2'
    group: "{{ instana.agent.group }}"
    owner: "{{ instana.agent.user }}"
    mode: 644
  when: instana.agent.updates.pin == "" and instana.agent.updates.enabled|bool

- name: 'template agent configuration'
  template:
    dest: "{{ config_dir }}instana/configuration.yaml"
    src: 'templates/agent_config.j2'
    group: "{{ instana.agent.group }}"
    owner: "{{ instana.agent.user }}"
    mode: 644
  when: instana.agent.zone != '' or (instana.agent.tags|length > 0)

- name: 'create agent meta config'
  file:
    path: "{{ config_prefix }}main.config.Agent.cfg"
    owner: "{{ instana.agent.user }}"
    group: "{{ instana.agent.group }}"
    mode: 644
    state: 'file'

- name: 'set agent mode in agent meta config'
  lineinfile:
    path: "{{ config_prefix }}main.config.Agent.cfg"
    line: "mode = {{ instana.agent.mode }}"
