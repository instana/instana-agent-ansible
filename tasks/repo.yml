# encoding: utf-8
%YAML 1.2
---

- set_fact:
    package_url: "https://_:{{ instana.agent.agent_key }}@packages.instana.io"

- name: 'get the package gpg key for the Instana Agent repo'
  get_url:
    url: 'https://packages.instana.io/Instana.gpg'
    dest: /tmp/instana.gpg
    mode: 644

- name: 'get the package gpg key into the apt keychain' # see beneath
  command: apt-key add /tmp/instana.gpg
  when: ansible_pkg_mgr == 'apt'

- name: 'create apt repo file' # apt_repository requires a python dep
  copy:
    dest: '/etc/apt/sources.list.d/instana-agent.list'
    content: "deb [arch=amd64] {{package_url}}/agent generic main"
    mode: 644
    owner: 'root'
    group: 'root'
  when: ansible_pkg_mgr == 'apt'

- name: 'add yum repo'
  yum_repository:
    baseurl: "{{ package_url }}/agent/generic/x86_64"
    description: 'The Agent repository by Instana, Inc.'
    enabled: yes
    gpgkey: 'https://packages.instana.io/Instana.gpg'
    gpgcheck: no
    name: 'Instana-Agent'
  when: ansible_pkg_mgr == 'yum'

- name: 'update apt repos'
  command: 'apt-get update'
  when: ansible_pkg_mgr == 'apt'

- name: 'update yum repos'
  command: 'yum makecache fast'
  when: ansible_pkg_mgr == 'yum'

- name: 'install agent package'
  package:
    name: "instana-agent-{{ instana.agent.flavor }}"
    state: 'latest'

- name: 'make sure the agent is stopped until its configured'
  service:
    name: 'instana-agent'
    state: 'stopped'
